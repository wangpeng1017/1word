generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model classes {
  id           String         @id
  name         String
  grade        String
  teacher_id   String
  is_active    Boolean        @default(true)
  created_at   DateTime       @default(now())
  updated_at   DateTime
  teachers     teachers       @relation(fields: [teacher_id], references: [id], onDelete: Cascade)
  plan_classes plan_classes[]
  students     students[]
}

model daily_tasks {
  id           String       @id
  studentId    String
  vocabularyId String
  taskDate     DateTime     @db.Date
  status       TaskStatus   @default(PENDING)
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  students     students     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  vocabularies vocabularies @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  @@unique([studentId, vocabularyId, taskDate])
  @@index([studentId, taskDate])
}

model plan_classes {
  id            String          @id
  class_id      String
  vocabulary_id String
  status        StudyPlanStatus @default(PENDING)
  start_date    DateTime        @db.Date
  end_date      DateTime?       @db.Date
  created_at    DateTime        @default(now())
  updated_at    DateTime
  classes       classes         @relation(fields: [class_id], references: [id], onDelete: Cascade)
  vocabularies  vocabularies    @relation(fields: [vocabulary_id], references: [id], onDelete: Cascade)

  @@unique([class_id, vocabulary_id])
  @@index([class_id])
  @@index([status])
}

model question_options {
  id         String    @id
  questionId String
  content    String
  isCorrect  Boolean   @default(false)
  order      Int
  createdAt  DateTime  @default(now())
  questions  questions @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model questions {
  id               String             @id
  vocabularyId     String
  type             QuestionType
  content          String
  sentence         String?
  audioUrl         String?
  correctAnswer    String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  question_options question_options[]
  vocabularies     vocabularies       @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)
  wrong_questions  wrong_questions[]
}

model students {
  id              String            @id
  user_id         String            @unique
  student_no      String            @unique
  class_id        String
  grade           String
  wechat_id       String?           @unique
  created_at      DateTime          @default(now())
  updated_at      DateTime
  daily_tasks     daily_tasks[]
  classes         classes           @relation(fields: [class_id], references: [id], onDelete: Cascade)
  users           users             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  study_plans     study_plans[]
  study_records   study_records[]
  word_masteries  word_masteries[]
  wrong_questions wrong_questions[]

  @@index([class_id])
  @@index([grade])
}

model study_plans {
  id           String          @id
  studentId    String
  vocabularyId String
  status       StudyPlanStatus @default(PENDING)
  reviewCount  Int             @default(0)
  lastReviewAt DateTime?
  nextReviewAt DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime
  students     students        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  vocabularies vocabularies    @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  @@unique([studentId, vocabularyId])
}

model study_records {
  id             String    @id
  studentId      String
  taskDate       DateTime  @db.Date
  totalWords     Int
  completedWords Int
  correctCount   Int
  wrongCount     Int
  accuracy       Float
  totalTime      Int
  startedAt      DateTime
  completedAt    DateTime?
  isCompleted    Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  students       students  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, taskDate])
}

model system_configs {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model teachers {
  id         String    @id
  user_id    String    @unique
  school     String?
  subject    String?   @default("英语")
  created_at DateTime  @default(now())
  updated_at DateTime
  classes    classes[]
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model users {
  id         String    @id
  email      String?   @unique
  phone      String?   @unique
  password   String
  name       String
  role       String    @default("STUDENT")
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  updated_at DateTime
  students   students?
  teachers   teachers?
}

model vocabularies {
  id                String            @id
  word              String            @unique
  part_of_speech    String[]
  primary_meaning   String
  secondary_meaning String?
  phonetic          String?
  phonetic_us       String?
  phonetic_uk       String?
  audio_url         String?
  is_high_frequency Boolean           @default(false)
  difficulty        String            @default("MEDIUM")
  created_at        DateTime          @default(now())
  updated_at        DateTime
  daily_tasks       daily_tasks[]
  plan_classes      plan_classes[]
  questions         questions[]
  study_plans       study_plans[]
  word_audios       word_audios[]
  word_images       word_images[]
  word_masteries    word_masteries[]
  wrong_questions   wrong_questions[]
}

model word_audios {
  id           String       @id
  vocabularyId String
  audioUrl     String
  accent       String       @default("US")
  duration     Int?
  createdAt    DateTime     @default(now())
  vocabularies vocabularies @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)
}

model word_images {
  id           String       @id
  vocabularyId String
  imageUrl     String
  description  String?
  createdAt    DateTime     @default(now())
  vocabularies vocabularies @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)
}

model word_masteries {
  id                 String       @id
  studentId          String
  vocabularyId       String
  totalWrongCount    Int          @default(0)
  recentAccuracy     Float?
  consecutiveCorrect Int          @default(0)
  isMastered         Boolean      @default(false)
  isDifficult        Boolean      @default(false)
  lastPracticeAt     DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime
  students           students     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  vocabularies       vocabularies @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  @@unique([studentId, vocabularyId])
  @@index([studentId, isDifficult])
  @@index([studentId, isMastered])
}

model wrong_questions {
  id            String       @id
  studentId     String
  vocabularyId  String
  questionId    String
  wrongAnswer   String
  correctAnswer String
  wrongAt       DateTime     @default(now())
  questions     questions    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  students      students     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  vocabularies  vocabularies @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  @@index([studentId, vocabularyId])
}

enum QuestionType {
  ENGLISH_TO_CHINESE
  CHINESE_TO_ENGLISH
  LISTENING
  FILL_IN_BLANK
}

enum StudyPlanStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  MASTERED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  INTERRUPTED
}

enum UserRole {
  TEACHER
  STUDENT
}

enum WordDifficulty {
  EASY
  MEDIUM
  HARD
}
