# 数据库迁移指南

## 新增字段说明

为支持小程序的听力题和填空题功能，需要在数据库中添加以下字段：

### 1. vocabularies 表
- **字段名**: `audio_url`
- **类型**: `VARCHAR(500)`
- **说明**: 存储单词发音的音频文件URL，用于听力题
- **可空**: 是

### 2. questions 表
- **字段名**: `sentence`
- **类型**: `TEXT`
- **说明**: 存储填空题的完整句子
- **可空**: 是（仅 FILL_IN_BLANK 题型使用）

---

## 方式一：通过 Vercel 控制台执行（推荐）

### 步骤：

1. **登录 Vercel**
   - 访问：https://vercel.com
   - 进入你的项目：`11word`

2. **打开数据库控制台**
   - 点击项目顶部的 "Storage" 标签
   - 选择你的 Postgres 数据库
   - 点击 "Query" 或 "SQL Editor"

3. **执行 SQL 脚本**
   复制以下 SQL 并执行：

```sql
-- 添加听力题和填空题所需字段

-- 1. 在 vocabularies 表中添加 audio_url 字段
ALTER TABLE vocabularies 
ADD COLUMN IF NOT EXISTS audio_url VARCHAR(500);

-- 2. 在 questions 表中添加 sentence 字段
ALTER TABLE questions 
ADD COLUMN IF NOT EXISTS sentence TEXT;

-- 添加注释
COMMENT ON COLUMN vocabularies.audio_url IS '音频URL，用于听力题快速访问';
COMMENT ON COLUMN questions.sentence IS '填空题的完整句子，FILL_IN_BLANK 题型使用';
```

4. **验证字段**
   执行以下查询验证字段是否添加成功：

```sql
-- 查看 vocabularies 表结构
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'vocabularies' 
AND column_name = 'audio_url';

-- 查看 questions 表结构
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'questions' 
AND column_name = 'sentence';
```

---

## 方式二：通过 Prisma CLI（需要本地配置）

### 前提条件：
- 正确配置 `.env` 文件中的 `DATABASE_URL`
- 可以访问线上数据库

### 步骤：

1. **确认 schema 更新**
   ```bash
   cd E:\trae\1单词\web-admin
   ```

2. **生成 Prisma 客户端**
   ```bash
   npx prisma generate
   ```

3. **推送到数据库**
   ```bash
   npx prisma db push
   ```

4. **重新部署到 Vercel**
   ```bash
   git add .
   git commit -m "feat: 添加听力题和填空题字段支持"
   git push
   ```

---

## 方式三：通过 Supabase/其他数据库管理工具

如果你使用的是 Supabase 或其他数据库：

1. 打开数据库管理界面
2. 找到 SQL Editor 或 Query 工具
3. 执行上述 SQL 脚本
4. 确认字段添加成功

---

## 数据填充建议

### 听力题音频 (audio_url)

可以使用以下几种方式获取音频：

#### 1. 免费 TTS 服务
- **Google Text-to-Speech**: https://cloud.google.com/text-to-speech
- **Microsoft Azure TTS**: https://azure.microsoft.com/zh-cn/products/cognitive-services/text-to-speech
- **讯飞开放平台**: https://www.xfyun.cn/services/online_tts

#### 2. 开源词典音频
- **Forvo**: https://forvo.com/
- **Cambridge Dictionary**: https://dictionary.cambridge.org/

#### 3. 批量生成脚本示例

```javascript
// 使用 Node.js 和 Google TTS 批量生成音频
const textToSpeech = require('@google-cloud/text-to-speech');
const fs = require('fs');
const { PrismaClient } = require('@prisma/client');

const client = new textToSpeech.TextToSpeechClient();
const prisma = new PrismaClient();

async function generateAudio(word) {
  const request = {
    input: { text: word },
    voice: { languageCode: 'en-US', ssmlGender: 'NEUTRAL' },
    audioConfig: { audioEncoding: 'MP3' },
  };

  const [response] = await client.synthesizeSpeech(request);
  
  // 保存到云存储（如 Vercel Blob、Cloudinary、AWS S3）
  const audioUrl = await uploadToStorage(response.audioContent, `${word}.mp3`);
  
  // 更新数据库
  await prisma.vocabulary.update({
    where: { word },
    data: { audioUrl }
  });
}
```

### 填空题句子 (sentence)

#### 示例数据格式：

```sql
-- 更新填空题的句子
UPDATE questions 
SET sentence = 'She is very _____ about her success.'
WHERE id = 'question_id_1' AND type = 'FILL_IN_BLANK';

UPDATE questions 
SET sentence = 'The book is on the _____.'
WHERE id = 'question_id_2' AND type = 'FILL_IN_BLANK';

UPDATE questions 
SET sentence = 'I will _____ you tomorrow.'
WHERE id = 'question_id_3' AND type = 'FILL_IN_BLANK';
```

#### 批量生成句子脚本：

```javascript
// 为每个单词生成填空句
async function generateFillInBlankSentences() {
  const vocabularies = await prisma.vocabulary.findMany();
  
  for (const vocab of vocabularies) {
    // 使用 AI 或模板生成句子
    const sentence = `The ${vocab.partOfSpeech[0]} is _____ in this context.`;
    
    // 查找或创建填空题
    await prisma.question.upsert({
      where: {
        vocabularyId_type: {
          vocabularyId: vocab.id,
          type: 'FILL_IN_BLANK'
        }
      },
      update: { sentence },
      create: {
        vocabularyId: vocab.id,
        type: 'FILL_IN_BLANK',
        content: vocab.word,
        sentence: sentence,
        correctAnswer: vocab.word,
        // ... 生成选项
      }
    });
  }
}
```

---

## 验证迁移成功

执行以下 SQL 查询，确认字段存在：

```sql
-- 检查 vocabularies 表
SELECT COUNT(*) as total_words,
       COUNT(audio_url) as words_with_audio,
       ROUND(COUNT(audio_url)::numeric / COUNT(*)::numeric * 100, 2) as audio_percentage
FROM vocabularies;

-- 检查 questions 表
SELECT type, 
       COUNT(*) as total_questions,
       COUNT(sentence) as questions_with_sentence
FROM questions
GROUP BY type;
```

---

## 回滚方案

如果需要回滚（不推荐，因为字段可空）：

```sql
-- 删除字段
ALTER TABLE vocabularies DROP COLUMN IF EXISTS audio_url;
ALTER TABLE questions DROP COLUMN IF EXISTS sentence;
```

---

## 常见问题

### Q: 迁移后小程序报错？
**A**: 确保重新部署了后端，并且 Prisma Client 已重新生成。

### Q: 听力题无法播放音频？
**A**: 检查：
1. `audio_url` 字段是否有值
2. 音频 URL 是否可访问
3. 小程序是否配置了音频域名白名单

### Q: 填空题显示异常？
**A**: 检查：
1. `sentence` 字段是否有值
2. 句子中是否包含 `_____` 占位符
3. 正确答案是否与单词匹配

---

## 下一步

1. ✅ 执行数据库迁移（添加字段）
2. ⏳ 准备音频资源
3. ⏳ 生成填空题句子
4. ⏳ 测试小程序听力题和填空题功能
