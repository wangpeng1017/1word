# 数据库初始化和功能测试指南

## 项目概述
这是一个智能词汇复习助手的Web管理后台，包含以下主要功能：
- 用户认证（教师/学生角色）
- 词汇管理（CRUD操作）
- 学生管理
- 班级管理
- 学习计划和任务管理

## 数据库初始化步骤

### 1. 环境配置
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑.env文件，填入PostgreSQL连接信息
DATABASE_URL="postgresql://username:password@localhost:5432/vocab_assistant?schema=public"
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
NEXT_PUBLIC_API_URL="http://localhost:3000"
```

### 2. 数据库Schema部署
```bash
# 生成Prisma客户端
npx prisma generate

# 推送数据库Schema（创建所有表）
npx prisma db push
```

### 3. 数据库初始化
#### 方式一：使用API接口
```bash
# POST请求初始化数据库
curl -X POST https://your-domain.vercel.app/api/setup

# 检查初始化状态
curl https://your-domain.vercel.app/api/setup
```

#### 方式二：使用脚本
```bash
# 运行初始化脚本
npm run db:init
```

## API测试清单

### 1. 认证系统测试
#### 注册教师账号
```bash
curl -X POST https://your-domain.vercel.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "teacher@example.com",
    "password": "password123",
    "name": "张老师",
    "role": "TEACHER"
  }'
```

#### 教师登录
```bash
curl -X POST https://your-domain.vercel.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "teacher@example.com",
    "password": "password123"
  }'
```

#### 获取当前用户信息
```bash
curl -X GET https://your-domain.vercel.app/api/auth/me \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 2. 词汇管理测试
#### 创建词汇
```bash
curl -X POST https://your-domain.vercel.app/api/vocabularies \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "word": "example",
    "partOfSpeech": ["n.", "v."],
    "primaryMeaning": "例子，实例",
    "secondaryMeaning": "举例说明",
    "phonetic": "/ɪɡˈzæmpl/",
    "isHighFrequency": true,
    "difficulty": "MEDIUM"
  }'
```

#### 获取词汇列表
```bash
curl -X GET https://your-domain.vercel.app/api/vocabularies \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 更新词汇
```bash
curl -X PUT https://your-domain.vercel.app/api/vocabularies/VOCAB_ID \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "primaryMeaning": "更新后的释义"
  }'
```

#### 删除词汇
```bash
curl -X DELETE https://your-domain.vercel.app/api/vocabularies/VOCAB_ID \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 3. 学生管理测试
#### 创建学生
```bash
curl -X POST https://your-domain.vercel.app/api/students \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "student@example.com",
    "password": "student123",
    "name": "小明",
    "studentNo": "2023001",
    "grade": "高三"
  }'
```

#### 获取学生列表
```bash
curl -X GET https://your-domain.vercel.app/api/students \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 批量导入学生
```bash
curl -X POST https://your-domain.vercel.app/api/students/import \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "students": [
      {
        "email": "student1@example.com",
        "name": "学生1",
        "studentNo": "2023001"
      },
      {
        "email": "student2@example.com", 
        "name": "学生2",
        "studentNo": "2023002"
      }
    ]
  }'
```

### 4. 班级管理测试
#### 创建班级
```bash
curl -X POST https://your-domain.vercel.app/api/classes \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "高三(1)班",
    "grade": "高三"
  }'
```

#### 获取班级列表
```bash
curl -X GET https://your-domain.vercel.app/api/classes \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Playwright自动化测试脚本

### 测试流程设计
1. 访问网站首页
2. 检查setup状态，如果未初始化则执行初始化
3. 测试登录功能
4. 测试词汇管理功能
5. 测试学生管理功能
6. 测试班级管理功能
7. 验证数据完整性

### 关键API端点验证
- `POST /api/setup` - 数据库初始化
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/me` - 获取用户信息
- `POST /api/vocabularies` - 创建词汇
- `GET /api/vocabularies` - 获取词汇列表
- `POST /api/students` - 创建学生
- `GET /api/students` - 获取学生列表
- `POST /api/classes` - 创建班级
- `GET /api/classes` - 获取班级列表

## 测试数据准备

### 示例词汇数据
```json
[
  {
    "word": "abandon",
    "partOfSpeech": ["v."],
    "primaryMeaning": "放弃，抛弃",
    "phonetic": "/əˈbændən/",
    "difficulty": "MEDIUM"
  },
  {
    "word": "ability", 
    "partOfSpeech": ["n."],
    "primaryMeaning": "能力，才能",
    "phonetic": "/əˈbɪləti/",
    "difficulty": "EASY"
  }
]
```

### 示例班级数据
```json
[
  {
    "name": "高三(1)班",
    "grade": "高三"
  },
  {
    "name": "高三(2)班", 
    "grade": "高三"
  }
]
```

## 错误排查清单

### 常见问题
1. **数据库连接失败**
   - 检查DATABASE_URL配置
   - 验证PostgreSQL服务状态
   - 确认网络连接

2. **JWT认证失败**
   - 检查JWT_SECRET配置
   - 验证token格式和有效期
   - 确认用户角色权限

3. **外键约束错误**
   - 检查数据关联完整性
   - 确认删除操作的级联设置
   - 验证数据类型匹配

### 数据库清理
```bash
# 删除所有表（注意：这会丢失所有数据）
npx prisma migrate reset

# 重新应用migration
npx prisma db push
```

## 监控和日志

### 健康检查
```bash
# 检查API服务状态
curl https://your-domain.vercel.app/api/health
```

### 关键指标
- 数据库连接数
- API响应时间
- 错误率
- 用户活跃度

## 部署后验证清单

- [ ] 数据库表创建成功
- [ ] 管理员账号可正常注册登录
- [ ] JWT认证功能正常
- [ ] 词汇CRUD操作正常
- [ ] 学生管理功能正常
- [ ] 班级管理功能正常
- [ ] 外键约束正确设置
- [ ] API响应时间正常
- [ ] 错误处理机制正常

## 后续优化建议

1. **数据备份策略**
2. **性能监控设置**
3. **用户权限细化**
4. **API限流配置**
5. **日志收集和分析**