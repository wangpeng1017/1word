import { PrismaClient } from '@prisma/client'
import * as fs from 'fs'
import * as path from 'path'

const prisma = new PrismaClient()

async function main() {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5)
  const backupDir = path.join(process.cwd(), 'backups')
  
  // åˆ›å»ºå¤‡ä»½ç›®å½•
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir, { recursive: true })
  }

  console.log('ðŸ”„ å¼€å§‹å¤‡ä»½å’Œè¿ç§»æµç¨‹...\n')

  try {
    // ==================== æ­¥éª¤1: æ•°æ®å¤‡ä»½ ====================
    console.log('ðŸ“¦ æ­¥éª¤ 1/4: å¤‡ä»½çŽ°æœ‰æ•°æ®...')
    
    const students = await prisma.student.findMany({
      include: {
        user: true,
        class: true,
      },
    })

    const studyPlans = await prisma.studyPlan.findMany()
    const classes = await prisma.class.findMany()
    
    const backup = {
      timestamp,
      students: students.map(s => ({
        id: s.id,
        userId: s.userId,
        studentNo: s.studentNo,
        classId: s.classId,
        grade: s.grade,
        userName: s.user.name,
        className: s.class?.name,
      })),
      studyPlans: studyPlans.length,
      classes: classes.length,
    }

    const backupFile = path.join(backupDir, `backup-${timestamp}.json`)
    fs.writeFileSync(backupFile, JSON.stringify(backup, null, 2))
    
    console.log(`âœ… å¤‡ä»½å®Œæˆ: ${backupFile}`)
    console.log(`   - å­¦ç”Ÿæ•°: ${students.length}`)
    console.log(`   - å­¦ä¹ è®¡åˆ’æ•°: ${studyPlans.length}`)
    console.log(`   - ç­çº§æ•°: ${classes.length}\n`)

    // ==================== æ­¥éª¤2: æ£€æŸ¥éœ€è¦è¿ç§»çš„æ•°æ® ====================
    console.log('ðŸ” æ­¥éª¤ 2/4: æ£€æŸ¥å¾…è¿ç§»æ•°æ®...')
    
    const studentsWithoutClass = students.filter(s => !s.classId || !s.grade)
    
    console.log(`   - éœ€è¦åˆ†é…ç­çº§çš„å­¦ç”Ÿ: ${studentsWithoutClass.length}`)
    
    if (studentsWithoutClass.length === 0) {
      console.log('âœ… æ‰€æœ‰å­¦ç”Ÿéƒ½å·²åˆ†é…ç­çº§ï¼Œæ— éœ€è¿ç§»\n')
      
      console.log('ðŸ“Š æ­¥éª¤ 3/4: æŽ¨é€ Schema å˜æ›´åˆ°æ•°æ®åº“...')
      console.log('âš ï¸  è¯·æ‰‹åŠ¨æ‰§è¡Œ: npx prisma db push')
      console.log('   (ç”±äºŽå¯èƒ½æ¶‰åŠå¤–é”®çº¦æŸå˜æ›´ï¼Œå»ºè®®æ‰‹åŠ¨ç¡®è®¤)\n')
      
      return
    }

    // ==================== æ­¥éª¤3: åˆ›å»ºæˆ–èŽ·å–é»˜è®¤ç­çº§ ====================
    console.log('\nðŸ« æ­¥éª¤ 3/4: å‡†å¤‡é»˜è®¤ç­çº§...')
    
    let defaultClass = await prisma.class.findFirst({
      where: { name: 'æœªåˆ†é…ç­çº§' },
    })

    if (!defaultClass) {
      // èŽ·å–æˆ–åˆ›å»ºé»˜è®¤æ•™å¸ˆ
      let defaultTeacher = await prisma.teacher.findFirst()

      if (!defaultTeacher) {
        console.log('   - æœªæ‰¾åˆ°æ•™å¸ˆï¼Œåˆ›å»ºé»˜è®¤æ•™å¸ˆè´¦æˆ·...')
        
        const existingAdmin = await prisma.user.findFirst({
          where: { email: 'admin@default.com' },
        })

        let adminUser = existingAdmin
        
        if (!existingAdmin) {
          adminUser = await prisma.user.create({
            data: {
              email: 'admin@default.com',
              password: '$2a$10$temp_password_hash_change_me',
              name: 'ç³»ç»Ÿç®¡ç†å‘˜',
              role: 'TEACHER',
            },
          })
        }

        defaultTeacher = await prisma.teacher.create({
          data: {
            userId: adminUser!.id,
            school: 'é»˜è®¤å­¦æ ¡',
            subject: 'è‹±è¯­',
          },
        })

        console.log('   âœ… é»˜è®¤æ•™å¸ˆåˆ›å»ºæˆåŠŸ')
      }

      // åˆ›å»ºé»˜è®¤ç­çº§
      defaultClass = await prisma.class.create({
        data: {
          name: 'æœªåˆ†é…ç­çº§',
          grade: 'å¾…åˆ†é…',
          teacherId: defaultTeacher.id,
          isActive: true,
        },
      })

      console.log('   âœ… é»˜è®¤ç­çº§åˆ›å»ºæˆåŠŸ')
    } else {
      console.log('   âœ… é»˜è®¤ç­çº§å·²å­˜åœ¨')
    }

    // ==================== æ­¥éª¤4: è¿ç§»å­¦ç”Ÿæ•°æ® ====================
    console.log('\nðŸ‘¥ æ­¥éª¤ 4/4: è¿ç§»å­¦ç”Ÿæ•°æ®...')
    
    let migratedCount = 0
    const migrationLog: any[] = []

    for (const student of studentsWithoutClass) {
      try {
        await prisma.student.update({
          where: { id: student.id },
          data: {
            classId: defaultClass.id,
            grade: defaultClass.grade,
          },
        })

        migratedCount++
        migrationLog.push({
          studentNo: student.studentNo,
          name: student.user.name,
          oldClassId: student.classId,
          oldGrade: student.grade,
          newClassId: defaultClass.id,
          newGrade: defaultClass.grade,
          status: 'success',
        })

        console.log(`   âœ… ${student.user.name} (${student.studentNo}) -> ${defaultClass.name}`)
      } catch (error: any) {
        migrationLog.push({
          studentNo: student.studentNo,
          name: student.user.name,
          status: 'failed',
          error: error.message,
        })
        console.log(`   âŒ ${student.user.name} è¿ç§»å¤±è´¥: ${error.message}`)
      }
    }

    // ä¿å­˜è¿ç§»æ—¥å¿—
    const migrationLogFile = path.join(backupDir, `migration-log-${timestamp}.json`)
    fs.writeFileSync(migrationLogFile, JSON.stringify(migrationLog, null, 2))

    console.log(`\nâœ… è¿ç§»å®Œæˆï¼`)
    console.log(`   - æˆåŠŸè¿ç§»: ${migratedCount} ä¸ªå­¦ç”Ÿ`)
    console.log(`   - è¿ç§»æ—¥å¿—: ${migrationLogFile}\n`)

    console.log('âš ï¸  é‡è¦æé†’ï¼š')
    console.log('   1. æ‰€æœ‰æœªåˆ†é…ç­çº§çš„å­¦ç”Ÿå·²ç§»è‡³ "æœªåˆ†é…ç­çº§"')
    console.log('   2. è¯·ç™»å½•ç®¡ç†åŽå°ä¸ºè¿™äº›å­¦ç”Ÿæ‰‹åŠ¨åˆ†é…æ­£ç¡®çš„ç­çº§')
    console.log('   3. å¤‡ä»½æ–‡ä»¶å·²ä¿å­˜åœ¨ backups/ ç›®å½•\n')

    console.log('ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š')
    console.log('   1. æ‰§è¡Œ: npx prisma db push')
    console.log('   2. æ‰§è¡Œ: npm run build')
    console.log('   3. é‡å¯æœåŠ¡: npm run dev\n')

  } catch (error: any) {
    console.error('âŒ è¿ç§»å¤±è´¥:', error.message)
    console.error('\nå›žæ»šå»ºè®®ï¼š')
    console.error(`   ä½¿ç”¨å¤‡ä»½æ–‡ä»¶æ¢å¤: ${backupDir}/backup-${timestamp}.json`)
    process.exit(1)
  }
}

main()
  .catch((e) => {
    console.error('ä¸¥é‡é”™è¯¯:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
